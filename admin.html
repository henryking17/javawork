<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Account - Login & Sign Up</title>
  <style>
    :root {
      --bg: #ffffff;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --primary: #E31837; /* red accent */
      --danger: #ef4444;
      --success: #22c55e;
      --border: #f1f1f1;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      display: grid;
      place-items: center;
      background: radial-gradient(1200px 600px at 20% 20%, #0b1220, var(--bg));
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      padding: 20px;
    }
    .card {
      width: 100%;
      max-width: 420px;
      background: var(--card);
      border: 1px solid rgba(227,24,55,0.08);
      border-radius: 12px;
      padding: 22px;
      box-shadow: 0 12px 30px rgba(14,22,35,0.06), inset 0 1px 0 rgba(255,255,255,0.6);
    }
    .header {
      margin-bottom: 18px;
    }
    .header h1 {
      margin: 0 0 6px;
      font-size: clamp(1.1rem, 2.8vw, 1.6rem);
      letter-spacing: 0.2px;
      line-height: 1.12;
    }
    .header p {
      margin: 0;
      color: var(--muted);
      font-size: clamp(0.85rem, 1.6vw, 1rem);
      opacity: 0.92;
    }
    .field {
      margin-bottom: 14px;
    }
    .label {
      display: block;
      margin-bottom: 6px;
      font-size: 0.9rem;
      color: var(--muted);
    }
    .input {
      width: 100%;
      padding: 12px 12px;
      border-radius: 10px;
      border: 1px solid #e6e6e6;
      background: #ffffff;
      color: #0b1220;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }
    .input:focus {
      border-color: var(--primary);
      box-shadow: 0 8px 20px rgba(227,24,55,0.08);
    }
    .error {
      margin-top: 6px;
      color: var(--danger);
      font-size: 0.85rem;
      min-height: 18px;
    }
    .actions {
      margin-top: 8px;
      display: flex;
      gap: 10px;
      align-items: center;  
    }
    .btn {
      appearance: none;
      border: none;
      border-radius: 8px;
      padding: 12px 14px;
      background: var(--primary);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.08s ease, filter 0.15s ease;
      box-shadow: 0 8px 18px rgba(227,24,55,0.12);
    }
    .btn.ghost { background: #fff; color: var(--primary); border: 1px solid var(--primary); box-shadow: none; }
    .btn:active { transform: translateY(1px); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn.loading { position: relative; pointer-events: none; }
    .btn.loading::after { content: ''; position: absolute; right: 12px; top: 50%; transform: translateY(-50%); width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.6); border-top-color: rgba(255,255,255,0.2); border-radius: 50%; animation: spin 900ms linear infinite; }

    .link {
      background: transparent;
      color: var(--muted);
      border: none;
      cursor: pointer;
      text-decoration: underline;
      padding: 8px 6px;
    }
    .notice {
      margin-top: 12px;
      font-size: 0.9rem;
      color: var(--muted);
    }
    .alert {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.04);
      background: #fff;
      color: #111827;
      display: none;
    }
    .alert.success { border-color: rgba(34,197,94,0.15); color: var(--success); display: block; }
    .alert.error { border-color: rgba(239,68,68,0.12); color: var(--danger); display: block; }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* Form animations */
    .auth-form { transition: opacity 220ms ease, transform 220ms ease; }
    .auth-form.hidden { opacity:0; transform: translateY(10px) scale(0.995); pointer-events:none; }
    .auth-form.shake { animation: shake 500ms ease; }
    @keyframes shake { 10%, 90% { transform: translateX(-1px); } 20%, 80% { transform: translateX(4px); } 30%, 50%, 70% { transform: translateX(-8px); } 40%, 60% { transform: translateX(8px); } }
    .form-switch {
      display: flex;
      gap: 10px;
      margin: 16px 0;
      justify-content: center;
    }
    .form-switch button {
      appearance: none;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .form-switch button.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    .hidden {
      display: none !important;
    }
    .back-link {
      margin-top: 16px;
      text-align: center;
    }
    .back-link a {
      color: var(--primary);
      text-decoration: none;
      font-size: 0.95rem;
    }
    .back-link a:hover {
      text-decoration: underline;
    }

    /* Back icon (Jumia-like, left and non-blocking) */
    .card { position: relative; }

    /* Brand/logo above header */
    .brand { text-align: center; margin-bottom: 12px; }
    .brand-logo { height: 64px; max-height: 80px; transition: transform 300ms ease, filter 220ms ease; display:inline-block; }
    .brand-logo:hover { transform: translateY(-4px) scale(1.02); filter: drop-shadow(0 8px 20px rgba(227,24,55,0.12)); }

    /* Center header content proportionally and keep back icon out of flow */
    .header { position: relative; padding: 18px 16px; display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:96px; }

    .header .back-icon { position:absolute; left:12px; top:18px; z-index:50; width:40px; height:40px; display:inline-flex; align-items:center; justify-content:center; border-radius:8px; text-decoration:none; color: var(--primary); border: 1px solid rgba(0,0,0,0.06); background: rgba(255,255,255,0.98); transition: transform 180ms ease, background 180ms ease, box-shadow 180ms ease; box-shadow: 0 6px 18px rgba(14,22,35,0.06); }
    .back-icon svg { width: 18px; height:18px; display:block; }
    .back-icon:focus { outline: 2px solid rgba(227,24,55,0.14); outline-offset: 2px; }
    .back-icon:hover { transform: translateX(-4px); color: #fff; background: var(--primary); box-shadow: 0 10px 24px rgba(227,24,55,0.12); }

    /* On small screens, reduce icon size and keep centered layout */
    @media (max-width: 520px) {
      .back-icon { left: 10px; width: 40px; height: 40px; }
      .brand-logo { height: 56px; }
      .header { padding-top: 10px; }
      .header h1 { font-size: 1.15rem; }
    }

    .card.exit-left { transform: translateX(-16px) scale(0.995); opacity: 0; transition: transform 220ms ease, opacity 220ms ease; }
  </style>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, fetchSignInMethodsForEmail, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, updateProfile, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";


    
    const firebaseConfig = {
  apiKey: "AIzaSyAtO7LjfyJYVk5CK00EEEDxFtr8IyLhsM0",
  authDomain: "cympetandconigeriaenterprise.firebaseapp.com",
  projectId: "cympetandconigeriaenterprise",
  storageBucket: "cympetandconigeriaenterprise.firebasestorage.app",
  messagingSenderId: "981106706732",
  appId: "1:981106706732:web:85662b3bb2826985a2c489",
  measurementId: "G-FXSZ2SK5SW"
};

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    auth.onAuthStateChanged(async user => {
  if (user) {
    // If user explicitly logged out earlier, prevent automatic re-login
    if (localStorage.getItem('user-logged-out')) {
      try { await signOut(auth); } catch (e) { /* ignore */ }
      try { await fetch('/auth/logout', { method: 'POST', credentials: 'include' }); } catch (e) { /* ignore */ }
      sessionStorage.removeItem('currentUser');
      localStorage.removeItem('user-logged-out');
      document.getElementById("welcomeMsg").innerText = "Please log in.";
      return;
    }

    // User is signed in
    document.getElementById("welcomeMsg").innerText = `Welcome, ${user.displayName || user.email}`;
  } else {
    // No user signed in
    document.getElementById("welcomeMsg").innerText = "Please log in.";
  }
});


    // Expose helper functions for the page and update sessionStorage on auth changes
    window.signUpWithFirebase = async function(name, email, password, phone) {
      try {
        // If user previously logged out, clear the flag when they actively sign up
        try { localStorage.removeItem('user-logged-out'); } catch (e) { /* ignore */ }
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        const user = cred.user;
        try { if (name) await updateProfile(user, { displayName: name }); } catch (e) { /* ignore */ }
        // store extra profile locally (phone)
        try { localStorage.setItem('firebase_profile_' + user.uid, JSON.stringify({ name: name || user.displayName || '', phone: phone || '' })); } catch (e) {}
        const profile = { id: user.uid, name: name || user.displayName || '', email: user.email, phone: phone || '' };

        // Exchange idToken for server-side session cookie
        try {
          const idToken = await user.getIdToken();
          await fetch('/auth/sessionLogin', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ idToken }), credentials: 'include' });
        } catch (e) { console.warn('Failed to create server session cookie after signup', e); }

        sessionStorage.setItem('currentUser', JSON.stringify(profile));
        return { success: true, user: profile };
      } catch (err) {
        return { success: false, error: err.message || String(err), code: err && err.code ? err.code : null };
      }
    };

    window.signInWithFirebase = async function(email, password) {
      try {
        // Clear explicit logout marker when user actively signs back in
        try { localStorage.removeItem('user-logged-out'); } catch (e) { /* ignore */ }
        const cred = await signInWithEmailAndPassword(auth, email, password);
        const user = cred.user;
        const stored = JSON.parse(localStorage.getItem('firebase_profile_' + user.uid) || '{}');
        const profile = { id: user.uid, name: user.displayName || stored.name || '', email: user.email, phone: stored.phone || '' };

        // Exchange idToken for server-side session cookie
        try {
          const idToken = await user.getIdToken();
          await fetch('/auth/sessionLogin', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ idToken }), credentials: 'include' });
        } catch (e) { console.warn('Failed to create server session cookie after sign-in', e); }

        sessionStorage.setItem('currentUser', JSON.stringify(profile));
        return { success: true, user: profile };
      } catch (err) {
        return { success: false, error: err.message || String(err), code: err && err.code ? err.code : null };
      }
    };

    window.signInWithGoogle = async function() {
      try {
        // Clear explicit logout marker when user actively signs back in with Google
        try { localStorage.removeItem('user-logged-out'); } catch (e) { /* ignore */ }
        const res = await signInWithPopup(auth, provider);
        const user = res.user;
        const profile = { id: user.uid, name: user.displayName || '', email: user.email, phone: '' };

        // Exchange idToken for server-side session cookie
        try {
          const idToken = await user.getIdToken();
          await fetch('/auth/sessionLogin', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ idToken }), credentials: 'include' });
        } catch (e) { console.warn('Failed to create server session cookie after Google sign-in', e); }

        sessionStorage.setItem('currentUser', JSON.stringify(profile));
        return { success: true, user: profile };
      } catch (err) {
        return { success: false, error: err.message || String(err), code: err && err.code ? err.code : null };
      }
    };

    window.signOutFirebase = async function() {
      try {
        await signOut(auth);
      } catch (e) { /* ignore */ }
      // Tell server to clear session cookie
      try { await fetch('/auth/logout', { method: 'POST', credentials: 'include' }); } catch (e) { console.warn('Server logout failed', e); }
      sessionStorage.removeItem('currentUser');
      return { success: true };
    };

    window.resetPasswordWithFirebase = async function(email) {
      try {
        await sendPasswordResetEmail(auth, email);
        return { success: true };
      } catch (err) {
        return { success: false, error: err.message || String(err), code: err && err.code ? err.code : null };
      }
    };

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // If the user explicitly logged out earlier, ensure we don't silently restore their session
        if (localStorage.getItem('user-logged-out')) {
          try { await signOut(auth); } catch (e) { /* ignore */ }
          try { await fetch('/auth/logout', { method: 'POST', credentials: 'include' }); } catch (e) { /* ignore */ }
          sessionStorage.removeItem('currentUser');
          localStorage.removeItem('user-logged-out');
          return;
        }

        const stored = JSON.parse(localStorage.getItem('firebase_profile_' + user.uid) || '{}');
        const profile = { id: user.uid, name: user.displayName || stored.name || '', email: user.email, phone: stored.phone || '' };
        sessionStorage.setItem('currentUser', JSON.stringify(profile));
      } else {
        sessionStorage.removeItem('currentUser');
      }
    });

    // Basic runtime check for Firebase Auth configuration: attempt to fetch sign-in methods for a dummy email.
    document.addEventListener('DOMContentLoaded', () => {
      try {
        if (typeof fetchSignInMethodsForEmail === 'function') {
          fetchSignInMethodsForEmail(auth, 'no-reply@example.cympet').catch(err => {
            if (err && (err.code === 'auth/configuration-not-found' || err.code === 'auth/operation-not-allowed')) {
              const fs = document.getElementById('firebaseStatus');
              if (fs) { fs.style.display = ''; fs.textContent = 'Firebase Auth appears not configured (Email/Password or Google sign-in). The page will fallback to local authentication.'; }
              const gBtn = document.getElementById('gSignBtn'); if (gBtn) gBtn.disabled = true;
              console.warn('Firebase Auth not configured:', err.code || err.message || err);
            }
          });
        }
      } catch (e) { /* ignore */ }
    });
  </script>
</head>
<body>
  <main class="card" aria-labelledby="form-title">
    <div class="brand" style="text-align:center; margin-bottom:14px;">
      <a href="index.html" aria-label="Home"><img src="Copilot_20251226_202609.png" alt="Cympet and Co Logo" class="brand-logo" /></a>
    </div>

    <div class="header">
      <a href="index.html" class="back-icon" aria-label="Back to home" title="Back to home">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
      </a>
      <h1 id="form-title">Welcome back</h1>
      <p id="form-subtitle">Sign in to continue</p>
    </div>

    <div class="form-switch">
      <button id="loginTabBtn" class="active" type="button" onclick="switchTab('login')">Login</button>
      <button id="signupTabBtn" type="button" onclick="switchTab('signup')">Sign Up</button>
    </div>

    <!-- LOGIN FORM -->
    <form id="loginForm" class="auth-form" novalidate>
      <div class="field">
        <label class="label" for="login-email">Email</label>
        <input class="input" id="login-email" name="email" type="email" autocomplete="email" required />
        <div class="error" id="loginEmailError"></div>
      </div>

      <div class="field">
        <label class="label" for="login-password">Password</label>
        <input class="input" id="login-password" name="password" type="password" autocomplete="current-password" required />
        <div class="error" id="loginPasswordError"></div>
      </div>

      <div class="actions">
        <button type="submit" class="btn" id="loginBtn">Log in</button>
      </div>

      <div class="alert" id="loginAlert" role="status" aria-live="polite"></div>
      <p class="notice">Use your registered email and password to login.</p>
      <div style="text-align: center; margin-top: 8px;">
        <button type="button" class="link" onclick="switchTab('forgot')">Forgot password?</button>
      </div>
    </form>

    <div style="margin-top: 12px; text-align: center;">
      <button id="gSignBtn" class="btn ghost" type="button">Continue with Google</button>
      <p class="notice">Or continue with Google</p>
      <div id="firebaseStatus" class="notice" style="margin-top:6px; display:none;"></div>
    </div>

    <!-- SIGNUP FORM -->
    <form id="signupForm" class="auth-form hidden" novalidate>
      <div class="field">
        <label class="label" for="signup-name">Full Name</label>
        <input class="input" id="signup-name" name="name" type="text" required />
        <div class="error" id="signupNameError"></div>
      </div>

      <div class="field">
        <label class="label" for="signup-email">Email</label>
        <input class="input" id="signup-email" name="email" type="email" autocomplete="email" required />
        <div class="error" id="signupEmailError"></div>
      </div>
      <div class="field">
        <label class="label" for="signup-phone">Phone Number</label>
        <input class="input" id="signup-phone" name="phone" type="tel" autocomplete="tel" required />
        <div class="error" id="signupPhoneError"></div>
      </div>

      <div class="field">
        <label class="label" for="signup-password">Password</label>
        <input class="input" id="signup-password" name="password" type="password" autocomplete="new-password" required />
        <div class="error" id="signupPasswordError"></div>
      </div>

      <div class="field">
        <label class="label" for="signup-confirm">Confirm Password</label>
        <input class="input" id="signup-confirm" name="confirm" type="password" autocomplete="new-password" required />
        <div class="error" id="signupConfirmError"></div>
      </div>

      <div class="actions">
        <button type="submit" class="btn" id="signupBtn">Create Account</button>
      </div>

      <div class="alert" id="signupAlert" role="status" aria-live="polite"></div>
      <p class="notice">Create an account to save your preferences and checkout faster.</p>
    </form>

    <!-- FORGOT PASSWORD FORM -->
    <form id="forgotForm" class="auth-form hidden" novalidate>
      <div class="field">
        <label class="label" for="forgot-email">Email Address</label>
        <input class="input" id="forgot-email" name="email" type="email" autocomplete="email" required />
        <div class="error" id="forgotEmailError"></div>
      </div>

      <div class="actions">
        <button type="submit" class="btn" id="forgotBtn">Send Reset Link</button>
      </div>

      <div class="alert" id="forgotAlert" role="status" aria-live="polite"></div>
      <p class="notice">We'll send a password reset link to your email. Check your spam folder if you don't see it.</p>
      <div style="text-align: center; margin-top: 8px;">
        <button type="button" class="link" onclick="switchTab('login')">← Back to Login</button>
      </div>

    <div class="back-link">
      <a href="index.html">← Back to Store</a>
    </div>
  </main>

  <script>
    // Load users from localStorage or use default
    let users = JSON.parse(localStorage.getItem('site_users') || '[]');
    // Web3Forms configuration - set your access key and admin email here
    // Get an access key from https://web3forms.com and replace the placeholder below.
    const WEB3FORMS_ACCESS_KEY = '22b0c187-7f5e-48e5-91cf-d3481d9cd44f'; // e.g. 'xxxxxxxx-xxxx-xxxx'
    const ADMIN_NOTIFICATION_EMAIL = 'henrycyprain2@gmail.com';
    
    // If empty, initialize with some default users for testing
    if (users.length === 0) {
      users = [
        {
          id: "u_1767140780755",
          name: "Henry Cyprain",
          email: "henry@test.com",
          phone: "+2348054059108",
          pwd: "Henrymyboy",
          created: "2025-12-31T00:26:20.757Z",
          isAdmin: true
        },
        {
          id: "u_1767147767666",
          name: "CYMPET ELECTRONICS",
          email: "cympet@test.com",
          phone: "+234855555555",
          pwd: "Cympet123",
          created: "2025-12-31T02:22:47.667Z"
        }
      ];
      localStorage.setItem('site_users', JSON.stringify(users));
    }

    let currentUser = JSON.parse(sessionStorage.getItem('currentUser') || 'null');

    function switchTab(tab) {
      const loginForm = document.getElementById('loginForm');
      const signupForm = document.getElementById('signupForm');
      const forgotForm = document.getElementById('forgotForm');
      const loginTabBtn = document.getElementById('loginTabBtn');
      const signupTabBtn = document.getElementById('signupTabBtn');
      const formTitle = document.getElementById('form-title');
      const formSubtitle = document.getElementById('form-subtitle');

      if (tab === 'login') {
        loginForm.classList.remove('hidden');
        signupForm.classList.add('hidden');
        forgotForm.classList.add('hidden');
        loginTabBtn.classList.add('active');
        signupTabBtn.classList.remove('active');
        formTitle.textContent = 'Welcome back';
        formSubtitle.textContent = 'Sign in to continue';
      } else if (tab === 'signup') {
        signupForm.classList.remove('hidden');
        loginForm.classList.add('hidden');
        forgotForm.classList.add('hidden');
        signupTabBtn.classList.add('active');
        loginTabBtn.classList.remove('active');
        formTitle.textContent = 'Create Account';
        formSubtitle.textContent = 'Join us today';
      } else if (tab === 'forgot') {
        forgotForm.classList.remove('hidden');
        loginForm.classList.add('hidden');
        signupForm.classList.add('hidden');
        loginTabBtn.classList.remove('active');
        signupTabBtn.classList.remove('active');
        formTitle.textContent = 'Reset Password';
        formSubtitle.textContent = 'Enter your email address';
      }
    }

    // LOGIN FORM
    const loginForm = document.getElementById('loginForm');
    const loginBtn = document.getElementById('loginBtn');

    function setLoginAlert(type, message) {
      const alert = document.getElementById('loginAlert');
      alert.className = 'alert ' + type;
      alert.textContent = message;
    }

    function clearLoginErrors() {
      document.getElementById('loginEmailError').textContent = '';
      document.getElementById('loginPasswordError').textContent = '';
      document.getElementById('loginAlert').className = 'alert';
      document.getElementById('loginAlert').textContent = '';
    }

    function validateLogin() {
      clearLoginErrors();
      let valid = true;
      
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;

      if (!email) {
        document.getElementById('loginEmailError').textContent = 'Email is required.';
        valid = false;
      } else if (!email.includes('@')) {
        document.getElementById('loginEmailError').textContent = 'Please enter a valid email.';
        valid = false;
      }

      if (!password) {
        document.getElementById('loginPasswordError').textContent = 'Password is required.';
        valid = false;
      } else if (password.length < 6) {
        document.getElementById('loginPasswordError').textContent = 'Password must be at least 6 characters.';
        valid = false;
      }

      return valid;
    }

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loginBtn.disabled = true;

      try {
        if (!validateLogin()) {
          setLoginAlert('error', 'Please fix the errors above.');
          return;
        }

        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value;

        // Prefer Firebase sign-in when available
        if (window.signInWithFirebase) {
          const res = await window.signInWithFirebase(email, password);
          if (!res || !res.success) {
            // If Firebase Auth is not configured, fallback to local user store
            if (res && (res.code === 'auth/configuration-not-found' || res.code === 'auth/operation-not-allowed')) {
              document.getElementById('firebaseStatus').style.display = '';
              document.getElementById('firebaseStatus').textContent = 'Firebase Auth not configured. Falling back to local authentication.';
              // try local sign-in
              const user = users.find(u => u.email === email && u.pwd === password);
              if (user) {
                const userSession = { id: user.id, name: user.name, email: user.email, phone: user.phone, isAdmin: user.isAdmin || false, loginTime: new Date().toISOString() };
                sessionStorage.setItem('currentUser', JSON.stringify(userSession));
                setLoginAlert('success', 'Login successful (local fallback)! Redirecting...');
                setTimeout(() => { window.location.href = 'index.html?login=success'; }, 800);
                return;
              }
              setLoginAlert('error', 'Invalid email or password. (Firebase not configured)');
              return;
            }

            setLoginAlert('error', res && res.error ? res.error : 'Invalid email or password.');
            return;
          }
          setLoginAlert('success', 'Login successful! Redirecting...');
          setTimeout(() => { window.location.href = 'index.html?login=success'; }, 800);
          return;
        }

        // Fallback to local users
        const user = users.find(u => u.email === email && u.pwd === password);
        if (!user) { setLoginAlert('error', 'Invalid email or password.'); return; }

        const userSession = { id: user.id, name: user.name, email: user.email, phone: user.phone, isAdmin: user.isAdmin || false, loginTime: new Date().toISOString() };
        sessionStorage.setItem('currentUser', JSON.stringify(userSession));
        setLoginAlert('success', 'Login successful! Redirecting...');
        setTimeout(() => { window.location.href = 'index.html?login=success'; }, 800);
      } catch (err) {
        setLoginAlert('error', 'An error occurred. Please try again.');
        console.error(err);
      } finally {
        loginBtn.disabled = false;
      }
    });

    // SIGNUP FORM
    const signupForm = document.getElementById('signupForm');
    const signupBtn = document.getElementById('signupBtn');

    function setSignupAlert(type, message) {
      const alert = document.getElementById('signupAlert');
      alert.className = 'alert ' + type;
      alert.textContent = message;
    }

    function clearSignupErrors() {
      document.getElementById('signupNameError').textContent = '';
      document.getElementById('signupEmailError').textContent = '';
      document.getElementById('signupPhoneError').textContent = '';
      document.getElementById('signupPasswordError').textContent = '';
      document.getElementById('signupConfirmError').textContent = '';
      document.getElementById('signupAlert').className = 'alert';
      document.getElementById('signupAlert').textContent = '';
    }

    function validateSignup() {
      clearSignupErrors();
      let valid = true;
      
      const name = document.getElementById('signup-name').value.trim();
      const email = document.getElementById('signup-email').value.trim();
      const phone = document.getElementById('signup-phone').value.trim();
      const password = document.getElementById('signup-password').value;
      const confirm = document.getElementById('signup-confirm').value;

      if (!name) {
        document.getElementById('signupNameError').textContent = 'Name is required.';
        valid = false;
      } else if (name.length < 3) {
        document.getElementById('signupNameError').textContent = 'Name must be at least 3 characters.';
        valid = false;
      }

      if (!email) {
        document.getElementById('signupEmailError').textContent = 'Email is required.';
        valid = false;
      } else if (!email.includes('@')) {
        document.getElementById('signupEmailError').textContent = 'Please enter a valid email.';
        valid = false;
      } else if (users.some(u => u.email === email)) {
        document.getElementById('signupEmailError').textContent = 'Email already registered.';
        valid = false;
      }

      if (!phone) {
        document.getElementById('signupPhoneError').textContent = 'Phone is required.';
        valid = false;
      } else if (phone.length < 10) {
        document.getElementById('signupPhoneError').textContent = 'Phone must be at least 10 digits.';
        valid = false;
      }

      if (!password) {
        document.getElementById('signupPasswordError').textContent = 'Password is required.';
        valid = false;
      } else if (password.length < 6) {
        document.getElementById('signupPasswordError').textContent = 'Password must be at least 6 characters.';
        valid = false;
      }

      if (!confirm) {
        document.getElementById('signupConfirmError').textContent = 'Please confirm password.';
        valid = false;
      } else if (password !== confirm) {
        document.getElementById('signupConfirmError').textContent = 'Passwords do not match.';
        valid = false;
      }

      return valid;
    }

    signupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      signupBtn.disabled = true;

      try {
        if (!validateSignup()) {
          setSignupAlert('error', 'Please fix the errors above.');
          return;
        }

        const name = document.getElementById('signup-name').value.trim();
        const email = document.getElementById('signup-email').value.trim();
        const phone = document.getElementById('signup-phone').value.trim();
        const password = document.getElementById('signup-password').value;

        // Prefer Firebase signup when available
        if (window.signUpWithFirebase) {
          const res = await window.signUpWithFirebase(name, email, password, phone);
          if (!res || !res.success) {
            // If Firebase Auth is not configured for this project, fallback to local store
            if (res && (res.code === 'auth/configuration-not-found' || res.code === 'auth/operation-not-allowed')) {
              document.getElementById('firebaseStatus').style.display = '';
              document.getElementById('firebaseStatus').textContent = 'Firebase Auth not configured (Email/Password). Account will be created locally instead.';
              // Create local fallback account
              const newUser = {
                id: 'u_fallback_' + Date.now(),
                name: name,
                email: email,
                phone: phone,
                pwd: password,
                created: new Date().toISOString(),
                isAdmin: false
              };
              users.push(newUser);
              localStorage.setItem('site_users', JSON.stringify(users));
              const customerNotif = {
                id: 'cnotif_' + Date.now(),
                userId: newUser.id,
                type: 'account_created',
                title: '✨ Welcome to Cympet and Co!',
                message: `Your account has been created successfully. Welcome ${name}!`,
                timestamp: new Date().toISOString(),
                read: false
              };
              localStorage.setItem('customer_notifications_' + newUser.id, JSON.stringify([customerNotif]));
              sessionStorage.setItem('currentUser', JSON.stringify({ id: newUser.id, name: newUser.name, email: newUser.email, phone: newUser.phone }));
              setSignupAlert('success', 'Account created locally (Firebase not configured). Redirecting...');
              setTimeout(() => { window.location.href = 'index.html?signup=success'; }, 1000);
              return;
            }
            setSignupAlert('error', res && res.error ? res.error : 'Failed to create account.');
            return;
          }
          // create a lightweight customer notification
          const customerNotif = {
            id: 'cnotif_' + Date.now(),
            userId: res.user.id,
            type: 'account_created',
            title: '✨ Welcome to Cympet and Co!',
            message: `Your account has been created successfully. Welcome ${name}!`,
            timestamp: new Date().toISOString(),
            read: false
          };
          localStorage.setItem('customer_notifications_' + res.user.id, JSON.stringify([customerNotif]));

          setSignupAlert('success', 'Account created successfully! Redirecting...');
          setTimeout(() => { window.location.href = 'index.html?signup=success'; }, 1000);
          return;
        }

        // Fallback: use local storage user store
        const newUser = {
          id: 'u_' + Date.now(),
          name: name,
          email: email,
          phone: phone,
          pwd: password,
          created: new Date().toISOString(),
          isAdmin: false
        };

        users.push(newUser);
        localStorage.setItem('site_users', JSON.stringify(users));

        const customerNotif = {
          id: 'cnotif_' + Date.now(),
          userId: newUser.id,
          type: 'account_created',
          title: '✨ Welcome to Cympet and Co!',
          message: `Your account has been created successfully. Welcome ${name}!`,
          timestamp: new Date().toISOString(),
          read: false
        };
        localStorage.setItem('customer_notifications_' + newUser.id, JSON.stringify([customerNotif]));

        // Auto-login new user (fallback)
        const userSession = { id: newUser.id, name: newUser.name, email: newUser.email, phone: newUser.phone, isAdmin: false, loginTime: new Date().toISOString() };
        sessionStorage.setItem('currentUser', JSON.stringify(userSession));

        setSignupAlert('success', 'Account created successfully! Redirecting...');
        setTimeout(() => {
          window.location.href = 'index.html?signup=success';
        }, 1000);
      } catch (err) {
        setSignupAlert('error', 'An error occurred. Please try again.');
        console.error(err);
      } finally {
        signupBtn.disabled = false;
      }
    });

    // FORGOT PASSWORD FORM
    const forgotForm = document.getElementById('forgotForm');
    const forgotBtn = document.getElementById('forgotBtn');

    function setForgotAlert(type, message) {
      const alert = document.getElementById('forgotAlert');
      alert.className = 'alert ' + type;
      alert.textContent = message;
    }

    function clearForgotErrors() {
      document.getElementById('forgotEmailError').textContent = '';
      document.getElementById('forgotAlert').className = 'alert';
      document.getElementById('forgotAlert').textContent = '';
    }

    function validateForgotEmail() {
      clearForgotErrors();
      let valid = true;
      const email = document.getElementById('forgot-email').value.trim();

      if (!email) {
        document.getElementById('forgotEmailError').textContent = 'Email is required.';
        valid = false;
      } else if (!email.includes('@')) {
        document.getElementById('forgotEmailError').textContent = 'Please enter a valid email.';
        valid = false;
      }
      return valid;
    }

    forgotForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      forgotBtn.disabled = true;

      try {
        if (!validateForgotEmail()) {
          setForgotAlert('error', 'Please fix the error above.');
          return;
        }

        const email = document.getElementById('forgot-email').value.trim();

        // Try Firebase password reset first
        if (window.resetPasswordWithFirebase) {
          const res = await window.resetPasswordWithFirebase(email);
          if (res && res.success) {
            setForgotAlert('success', 'Password reset link sent! Check your email.');
            document.getElementById('forgot-email').value = '';
            setTimeout(() => { switchTab('login'); }, 2000);
            return;
          } else if (res && (res.code === 'auth/configuration-not-found' || res.code === 'auth/operation-not-allowed' || res.code === 'auth/user-not-found')) {
            // Firebase not configured or user not found; fallback to local
            const user = users.find(u => u.email === email);
            if (!user) {
              setForgotAlert('error', 'No account found with that email address. (Local fallback)');
              return;
            }
            // Generate a temporary password reset token (valid for 1 hour)
            const resetToken = 'reset_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const resetData = {
              token: resetToken,
              email: email,
              userId: user.id,
              expiresAt: Date.now() + 3600000 // 1 hour
            };
            localStorage.setItem('password_reset_' + resetToken, JSON.stringify(resetData));

            // In production, this would send an email with a link like:
            // https://yoursite.com/reset-password.html?token=reset_xxxxx
            // For now, show the token in localStorage for testing
            console.log('Password reset token (for testing):', resetToken);
            setForgotAlert('success', 'Password reset link sent! (Check console or check email in production)');
            document.getElementById('forgot-email').value = '';
            setTimeout(() => { switchTab('login'); }, 2000);
            return;
          }
          setForgotAlert('error', res && res.error ? res.error : 'Failed to send reset link.');
          return;
        }

        // Fallback: local password reset
        const user = users.find(u => u.email === email);
        if (!user) {
          setForgotAlert('error', 'No account found with that email address.');
          return;
        }

        // Generate a temporary reset token
        const resetToken = 'reset_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const resetData = {
          token: resetToken,
          email: email,
          userId: user.id,
          expiresAt: Date.now() + 3600000
        };
        localStorage.setItem('password_reset_' + resetToken, JSON.stringify(resetData));

        console.log('Password reset token (for testing):', resetToken);
        setForgotAlert('success', 'Password reset link sent! (Check console for token in testing)');
        document.getElementById('forgot-email').value = '';
        setTimeout(() => { switchTab('login'); }, 2000);
      } catch (err) {
        setForgotAlert('error', 'An error occurred. Please try again.');
        console.error(err);
      } finally {
        forgotBtn.disabled = false;
      }
    });

    // Attempt to hydrate currentUser from server session (if server auth in use)
    if (!currentUser) {
      try {
        fetch('/auth/me', { credentials: 'same-origin' }).then(r => r.json()).then(data => {
          if (data && data.user) {
            sessionStorage.setItem('currentUser', JSON.stringify(data.user));
            window.location.reload();
            return;
          }
          // If no server session, check Firebase-initialized session (auth module will sync sessionStorage)
          const fb = sessionStorage.getItem('currentUser');
          if (fb) { window.location.reload(); }
        }).catch(() => {
          const fb = sessionStorage.getItem('currentUser');
          if (fb) { window.location.reload(); }
        });
      } catch (e) { const fb = sessionStorage.getItem('currentUser'); if (fb) window.location.reload(); }
    }

    // Wire up Google sign-in button if available
    try {
      const gBtn = document.getElementById('gSignBtn');
      if (gBtn) {
        gBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          try {
            if (window.signInWithGoogle) {
              const res = await window.signInWithGoogle();
              if (res && res.success) { window.location.href = 'index.html?login=success'; }
              else {
                setLoginAlert('error', res && res.error ? res.error : 'Google sign-in failed');
                if (res && (res.code === 'auth/configuration-not-found' || res.code === 'auth/operation-not-allowed')) {
                  const fs = document.getElementById('firebaseStatus');
                  if (fs) { fs.style.display = ''; fs.textContent = 'Google sign-in is not enabled in Firebase Auth for this project.'; }
                  try { gBtn.disabled = true; } catch (e) {}
                }
              }
            } else {
              setLoginAlert('error', 'Google sign-in not configured');
            }
          } catch (err) { console.error(err); setLoginAlert('error', 'Google sign-in failed'); }
        });
      }
    } catch (e) { /* ignore */ }
    // Initialize Google Sign-In after fetching server config (robust: wait for GSI to load)
    (function initGoogleSignIn() {
      try {
        fetch('/config').then(r => r.json()).then(cfg => {
          if (!cfg || !cfg.googleClientId) return;

          const tryInit = (attempts = 0) => {
            if (window.google && google.accounts && google.accounts.id) {
              const onGoogleToken = async (response) => {
                try {
                  const id_token = response && response.credential;
                  if (!id_token) return setLoginAlert('error', 'Google sign-in failed (no token).');

                  const res = await fetch('/auth/google', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ id_token }) });
                  const body = await res.json().catch(() => ({}));
                  if (res.ok && body && body.success && body.user) {
                    sessionStorage.setItem('currentUser', JSON.stringify(body.user));
                    window.location.href = 'index.html?login=success';
                  } else {
                    setLoginAlert('error', (body && body.error) || 'Google sign-in failed');
                  }
                } catch (err) {
                  console.error('Google sign-in error', err);
                  setLoginAlert('error', 'Google sign-in error');
                }
              };

              try {
                google.accounts.id.initialize({ client_id: cfg.googleClientId, callback: onGoogleToken });
                try { google.accounts.id.renderButton(document.getElementById('gSignInBtn'), { theme: 'outline', size: 'large' }); } catch (e) { /* ignore render errors */ }
              } catch (e) {
                console.warn('Error initializing GSI:', e);
              }
              return;
            }

            if (attempts < 30) {
              setTimeout(() => tryInit(attempts + 1), 100);
            } else {
              console.warn('Google Identity Services did not load in time; signin button may not appear.');
            }
          };

          tryInit(0);
        }).catch((err) => { console.warn('Failed to fetch /config for Google Sign-In', err); });
      } catch (e) { console.warn('Error initializing Google Sign-In', e); }
    })();


    // Check if already logged in
    if (currentUser) {
      document.body.innerHTML = `
        <main class="card">
          <div class="header">
            <h1>Already Logged In</h1>
            <p>Welcome, ${escapeHtml(currentUser.name)}!</p>
          </div>
          <div style="margin-top: 20px;">
            <p><strong>Email:</strong> ${escapeHtml(currentUser.email)}</p>
            <p><strong>Phone:</strong> ${escapeHtml(currentUser.phone)}</p>
          </div>
          <div class="actions">
            <button class="btn" onclick="logout()">Logout</button>
            <button class="link" onclick="window.location.href='index.html'">Back to Store</button>
          </div>
        </main>
      `;

      async function logout() {
        try {
          // Prefer Firebase sign-out when available
          if (window.signOutFirebase) await window.signOutFirebase();
          else await fetch('/auth/logout', { method: 'POST', credentials: 'same-origin' });
        } catch (e) { /* ignore */ }
        // Clear session and notify other tabs
        sessionStorage.removeItem('currentUser');
        try { localStorage.setItem('currentUser', 'null'); localStorage.setItem('logout', String(Date.now())); } catch (err) {}
        // Redirect to storefront (logged-out view)
        window.location.href = 'index.html';
      }
    }

    // Keyboard & back-icon handlers: Escape to go home, and animated back click
    document.addEventListener('keydown', (e) => { try { if (e.key === 'Escape') window.location.href = 'index.html'; } catch (err) {} });
    try {
      const backIcon = document.querySelector('.back-icon');
      if (backIcon) {
        backIcon.addEventListener('click', (ev) => {
          ev.preventDefault();
          const card = document.querySelector('.card');
          if (card) {
            card.classList.add('exit-left');
            setTimeout(() => { window.location.href = backIcon.href || 'index.html'; }, 220);
          } else {
            window.location.href = backIcon.href || 'index.html';
          }
        });
      }
    } catch (e) { /* ignore */ }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>