<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Receipt</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Keep the receipt layout simple and printable */
    body { background: #f7fafc; color: #111827; font-family: Arial, sans-serif; padding: 20px; }
    .receipt { max-width: 760px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 8px 24px rgba(16,24,40,0.06); }
    .receipt h1 { margin-top: 0; font-size: 1.25rem; }
    .meta { color: #6b7280; margin-bottom: 12px; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { padding: 8px; border-bottom: 1px solid #eee; text-align: left; }
    .total { text-align: right; font-weight: 700; margin-top: 12px; }
    .actions { margin-top: 14px; display:flex; gap:8px; justify-content: flex-end; }
    .btn { padding: 8px 12px; border-radius: 8px; border: none; cursor: pointer; }
    .btn.primary { background: #dc143c; color: white; }
    .btn.ghost { background: transparent; border: 1px solid #e5e7eb; }
  </style>
</head>
<body>
  <div class="receipt" id="receipt-root">
    <div id="loading">Loading receipt...</div>
  </div>

  <script>
    // Helper: parse query parameters
    function qs(key) {
      const params = new URLSearchParams(window.location.search);
      return params.get(key);
    }

    function formatPrice(amount) {
      if (!amount) return '';
      // If amount already contains currency sign (like "₦250,000"), return as-is
      if (typeof amount === 'string' && amount.trim().startsWith('₦')) return amount;
      return '₦' + Number(amount).toLocaleString();
    }

    function findOrder(orderId) {
      if (!orderId) return null;
      // Normalize the search key
      const needle = String(orderId);

      // Try user-scoped storage first (if available)
      const currentUserData = JSON.parse(sessionStorage.getItem('currentUser') || 'null');
      const uid = currentUserData ? (currentUserData.email || currentUserData.id) : null;

      const triedKeys = [];
      if (uid) triedKeys.push(`paid_orders_${uid}`, `cash_orders_${uid}`);
      triedKeys.push('paid_orders', 'cash_orders');

      const matches = (o) => {
        if (!o) return false;
        // Match orderId or payment_reference (some flows use that)
        if (o.orderId && String(o.orderId) === needle) return true;
        if (o.payment_reference && String(o.payment_reference) === needle) return true;
        // Some older records may store id under different keys
        if (o.id && String(o.id) === needle) return true;
        return false;
      };

      // Search the most-likely keys first
      for (const key of triedKeys) {
        try {
          const arr = JSON.parse(localStorage.getItem(key) || '[]');
          const found = arr.find(matches);
          if (found) return found;
        } catch (e) { /* ignore malformed entries */ }
      }

      // As a last resort, scan all paid_/cash_ keys across localStorage (covers per-user keys when session is missing)
      try {
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (!key) continue;
          if (!/^paid_orders(_.*)?$/.test(key) && !/^cash_orders(_.*)?$/.test(key)) continue;
          if (triedKeys.includes(key)) continue; // already tried
          try {
            const arr = JSON.parse(localStorage.getItem(key) || '[]');
            const found = arr.find(matches);
            if (found) return found;
          } catch (e) { /* ignore malformed entries */ }
        }
      } catch (e) { /* ignore localStorage iteration errors */ }

      return null;
    }

    (function render() {
      const root = document.getElementById('receipt-root');
      const orderId = qs('orderId');
      
      if (!orderId) {
        root.innerHTML = '<div style="color:#9ca3af;">No order specified.</div>';
        return;
      }
      
      const order = findOrder(orderId);
      if (!order) {
        root.innerHTML = `<div style="color:#9ca3af;">Receipt not found for Order ID: <strong>${orderId}</strong> — If this was made under your account, open the site and log in, then try viewing the receipt again.</div>`;
        return;
      }

      // Build HTML
      let html = '';
      html += `<div style="text-align:center; margin-bottom:12px;"><img src="Copilot_20251226_202609.png" alt="Cympet and Co Logo" style="height:64px; display:inline-block;"></div>`;
      html += `<h1>Receipt — ${order.orderId}</h1>`;
      const methodText = order.payment_method ? order.payment_method : (order._type === 'paid' ? 'Paid via Paystack' : (order.delivery_type ? (order.delivery_type === 'pickup' ? 'Pickup' : 'Home Delivery') : 'Cash on Delivery'));
      html += `<div class="meta">${methodText}</div>`;
      html += `<div><strong>Customer:</strong> ${order.name || ''}</div>`;
      if (order.phone) html += `<div><strong>Phone:</strong> ${order.phone}</div>`;
      if (order.email) html += `<div><strong>Email:</strong> ${order.email}</div>`;
      if (order.delivery_type) html += `<div><strong>Delivery Type:</strong> ${order.delivery_type === 'pickup' ? 'Pickup' : 'Home Delivery'}</div>`;
      if (order.address) html += `<div><strong>Address:</strong> ${order.address}</div>`;

      html += `<div style="margin-top:12px;"><strong>Items</strong></div>`;
      html += '<table><thead><tr><th style="text-align:left">Item</th><th style="text-align:right">Qty</th><th style="text-align:right">Line Total</th></tr></thead><tbody>';

      if (Array.isArray(order.cart) && order.cart.length) {
        order.cart.forEach(it => {
          const qty = it.quantity || 1;
          const line = it.item_total || it.unit_price || '';
          html += `<tr><td>${it.name}</td><td style="text-align:right">${qty}</td><td style="text-align:right">${line}</td></tr>`;
        });
      } else {
        html += '<tr><td colspan="3">No items recorded.</td></tr>';
      }
      html += '</tbody></table>';

      html += `<div class="total">Total: ${order.total || ''}</div>`;
      // Format order timestamp in 12-hour format
      function formatDateTime12_local(input) {
        if (!input) return '';
        const d = (input instanceof Date) ? input : new Date(input);
        try { return d.toLocaleString(undefined, { year:'numeric', month:'short', day:'numeric', hour:'numeric', minute:'2-digit', hour12:true }); }
        catch (e) { const hh = d.getHours(); const mm = String(d.getMinutes()).padStart(2,'0'); const ampm = hh>=12 ? 'PM' : 'AM'; const hr12 = ((hh+11)%12)+1; return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()} ${hr12}:${mm} ${ampm}`; }
      }
      html += `<div style="color:#6b7280; margin-top:6px;">Order Date: ${formatDateTime12_local(order.timestamp)}</div>`;

      html += '<div class="actions">';
      html += '<button class="btn primary" id="printBtn">Print / Save as PDF</button>';
      html += '<button class="btn ghost" id="closeBtn">Close</button>';
      html += '</div>';

      root.innerHTML = html;

      // Hook buttons
      document.getElementById('printBtn').addEventListener('click', () => {
        window.print();
      });
      document.getElementById('closeBtn').addEventListener('click', () => {
        window.close();
      });
    })();
  </script>
</body>
</html>